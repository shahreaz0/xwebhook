generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ---------------------------------
// Enums
// ---------------------------------

enum MessageStatus {
  PENDING // waiting to be sent
  PROCESSING // currently sending
  DELIVERED // successfully sent
  FAILED // failed
  RETRYING // failed before but retrying
  SKIPPED // intentionally not sent
  EXPIRED // delivery expired
}

// ---------------------------------
// Models
// ---------------------------------
model User {
  id       String  @id @default(cuid(2))
  email    String  @unique
  password String
  name     String?

  apps     Application[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Session {
  id        String   @id @default(cuid(2))
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  token     String   @unique

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, expiresAt])
  @@index([userId])
}

model Application {
  id          String  @id @default(cuid(2))
  name        String
  description String?
  userId      String
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  appUsers   AppUser[]
  eventTypes EventType[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([name])
}

model AppUser {
  id            String      @id @default(cuid(2))
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  userId        String
  email         String
  metadata      Json?

  webhooks Webhook[]
  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([applicationId, userId]) // Prevent duplicates
  @@index([applicationId])
  @@index([email])
}

model Webhook {
  id          String  @id @default(cuid(2))
  url         String
  secrets     String
  description String?
  disabled    Boolean @default(false)
  archived    Boolean @default(false)
  metadata    Json?
  rateLimit   Int?
  appUser     AppUser @relation(fields: [appUserId], references: [id], onDelete: Cascade)
  appUserId   String

  eventTypes WebhookEventType[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([appUserId, url])
  @@index([appUserId])
  @@index([url])
  @@index([disabled])
}

model EventType {
  id            String      @id @default(cuid(2))
  name          String
  description   String?
  applicationId String
  application   Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  messages           Message[]
  webhookConnections WebhookEventType[]

  archived   Boolean @default(false)
  deprecated Boolean @default(false)
  groupName  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([applicationId, name])
  @@index([applicationId])
}

model WebhookEventType {
  webhookId   String
  eventTypeId String

  webhook   Webhook   @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  eventType EventType @relation(fields: [eventTypeId], references: [id], onDelete: Cascade)

  @@id([webhookId, eventTypeId])
  @@index([eventTypeId])
}

model Message {
  id          String        @id @default(cuid(2))
  appUser     AppUser       @relation(fields: [appUserId], references: [id], onDelete: Cascade)
  appUserId   String
  eventType   EventType     @relation(fields: [eventTypeId], references: [id], onDelete: Cascade)
  eventTypeId String
  payload     Json
  status      MessageStatus @default(PENDING)
  deliverAt   DateTime?
  createdAt   DateTime      @default(now())

  @@index([eventTypeId])
  @@index([appUserId])
  @@index([deliverAt])
  @@index([status, deliverAt])
}
